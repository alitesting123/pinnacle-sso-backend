container_commands:
  01_run_migration:
    command: |
      echo "======================================"
      echo "DATABASE MIGRATION - VERBOSE MODE"
      echo "======================================"

      # Check if psql is available
      if ! command -v psql &> /dev/null; then
          echo "ERROR: psql not found. Installing..."
          yum install -y postgresql15 2>&1
      else
          echo "✓ psql found: $(which psql)"
          echo "✓ psql version: $(psql --version)"
      fi

      # Check DATABASE_URL
      if [ -z "$DATABASE_URL" ]; then
          echo "ERROR: DATABASE_URL environment variable not set!"
      else
          echo "✓ DATABASE_URL is set (masked for security)"
      fi

      # Run the migration
      if [ -f migrations/add_ai_generated_field.sql ]; then
          echo "✓ Found migration file at migrations/add_ai_generated_field.sql"
          echo "File contents:"
          cat migrations/add_ai_generated_field.sql
          echo ""
          echo "Executing migration..."
          psql "$DATABASE_URL" -f migrations/add_ai_generated_field.sql 2>&1 | tee /tmp/migration.log

          if [ $? -eq 0 ]; then
              echo "✓ Migration completed successfully!"
          else
              echo "⚠ Migration may have already been applied (this is okay)"
              echo "Migration output saved to /tmp/migration.log"
          fi
      else
          echo "⚠ Migration file not found at migrations/add_ai_generated_field.sql"
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la migrations/ 2>&1 || echo "migrations/ directory not found"
      fi

      echo "======================================"
    leader_only: true
    ignoreErrors: true
